# 🔔 모던 자바스크립트 Deep Dive 23장

**23장 실행 컨텍스트**

```
23-1. 소스코드의 타입
    - 전역코드, 함수코드, eval코드, 모듈코드로 구분한다.
    - 소스코드 타입에 따라 실행 컨텍스트를 생성하는 과정과 관리내용이 다르다.
    - 전역코드
        > 전역코드는 전역스코프를 생성하고, var키워드로 선언된 전역변수와 함수선언문으로
          선언된 전역함수를 전역객체의 프로퍼티와 메서드로 바인딩한다.
          이를 위해 전역코드가 평가되면 전역실행 컨텍스트가 생성된다.
    - 함수코드
        > 함수코드는 지역스코프를 생성하고 지역변수,parameter,arguments객체를 관리한다.
          이를위해 함수코드가 평가되면 함수실행 컨텍스트가 생성된다.
    - eval코드
        > eval코드는 strict mode에서 자신만의 독자적인 스코프를 생성한다.
          이를 위해 eval 코드가 평가되면 eval실행 컨텍스트가 생성된다.
    - 모듈코드
        > 모듈별로 독립적인 모듈스코프를 생성한다. 이를위해 모듈코드가 평가되면 모듈실행
          컨텍스트가 생성된다.

23-2. 소스코드의 평가와 실행
    - 모든 소스코드는 실행에 앞서 평가 과정을 거치며, 자바스크립트 엔진은 소스코드를
      2개의 과정, 즉 '소스코드 평가'와 '소스코드 실행'과정으로 나누어 처리한다.
    - 소스코드 평가 과정에서는 실행 컨텍스트를 생성하고 변수,함수 등의 선언문만
      실행 컨텍스트가 관리하는 스코프(렉시컬환경의 환경레코드)에 등록한다.
    - 소스코드 실행 과정에서는 런타임이 시작되고 변수나 함수의 참조를 실행 컨텍스트가
      관리하는 스코프에서 검색해서 취득한다.
      변수값의 변경 등 소스코드의 실행 결과는 다시 실행 컨텍스트가 관리하는 스코프에 등록된다.

23-3. 실행컨텍스트의 역할
    - 전역코드 평가
        > 먼저 전역코드 평가과정을 거치며 선언문만 실행해둔다.
          전역코드의 변수 선언문과 함수선언문이 먼저 실행되고,
          전역변수와 전역함수가 실행컨텍스트가 관리하는 전역스코프에 등록된다.
          전역변수와 전역함수는 전역객체의 프로퍼티와 메서드가 된다.
    - 전역코드 실행
        > 런타임이 시작되어 순차적으로 전역변수의 ㄱ밧이 할당되고 함수가 호출된다.
          함수가 호출되면 순차적으로 실행되던 전역코드의 실행을 일시 중단하고
        함수 내부로 진입한다.
    - 함수코드 평가
        > 함수 내부로 진입하면 함수코드 평가 과정을 거치며
          이때 parameter와 지역변수 선언문이 먼저 실행되고,
          parameter와 지역변수가 실행컨텍스트가 관리하는 지역스코프에 등록된다.
          또한 arguments객체가 생서되어 지역 스코프에 등록되고 this바인딩도 결정된다.
    - 함수코드 실행
        > 런타임이 시작되어 순차적으로 paramter와 지역변수에 값이 할당된다.
    - 이처럼  코드가 실행되려면 스코프,식별자,코드실행 순서등의 관리가 필요하다.
    - 실행컨텍스트는 소스코드를 실행하는 데 필요한 환경을 제공하고,
      코드의 실행 결과를 실제로 관리하는 영역이다.
    - 식별자와 스코프는 렉시컬 환경으로 관리하고, 코드 실행 순서는 실행 컨텍스트 스택으로 관리한다.

23-4. 실행컨텍스트 스택
    - 자바스크립트 엔진은 먼저 전역 실행컨텍스트를 생성하고 함수가 호출되면 그 위에
      함수 실행 컨텍스트를 생성한다. 실행컨텍스트는 나중에 실행된것이 제일 위쪽으로 오고
      이러한 것을 실행컨텍스트 스택이라고 한다.
    - 실행컨텍스트 스택은 코드의 실행순서를 관리한다.
      실행컨텍스트 스택의 최상위에 존재하는 실행컨텍스트는 현재 실행중인 코드의 실행컨텍스트이고,
      실행중인 실행컨텍스트라고 부른다.

23-5. 렉시컬 환경
    - 렉시컬 환경은 식별자와 식별자에 바인딩된 값, 상위 스코프에 대한 참조를 기록하는
      자료구조로 실행컨텍스트를 구성하는 컴포넌트다.
    - 렉시컬 환경은 객체형태이고, 식별자를 키로 등록하고 식별자에 바인딩 된 값을 관리한다.
      렉시컬 환경은 스코프를 구분하여 식별자를 등록하고 관리하는 저장소 역할을 한다.
    - 실행컨텍스트는 렉시컬환경 컴포넌트와 변수환경컴포넌트로 구성되어있다.
      이 두 컴포넌트는 하나의 동일한 렉시컬 환경을 참조하지만
      이후 몇가지 상황을 만나면 변수환경컴포넌트를 위한 새로운 렉시컬 환경이 생성된다.
    - 렉시컬 환경은 환경레코드/외부렉시컬환경에대한 참조컴포넌트로 나뉜다.
        > 환경레코드는 식별자를 등록하고 등록된 식별자에 바인딩 된 값을 관리하는 저장소다.
        > 외부렉시컬환경에 대한 참조는 상위 스코프를 가리킨다.

23-6. 실행 컨텍스트의 생성과 식별자 검색 과정
    - 먼저 전역객체를 생성한다
        > 전역객체는 전역코드가 평가되기 이전에 생성되고,
          전역 객체에는 빌트인 전역 프로퍼티와 빌트인 전역함수, 표준 빌트인 객체가 추가되며
          동작환경에 따라 클라이언트 사이드 Web API 또는 특정 환경을 위한 호스트 객체를 포함한다. (전역객체도 Object.prototype을 상속받는다)
    - 전역 코드 평가가 시작된다
        > 소스코드가 로드되면 다음순서대로 전역코드를 평가한다.
            > 1.전역실행 컨텍스트 생성
                전역실행 컨텍스트를 생성하여 실행컨텍스트 스택에 푸시한다.
              2.전역렉시컬 환경 생성
                전역 렉시컬환경을 생성하고 전역실행 컨텍스트에 바인딩한다.
                렉시컬환경은 환경레코드와 외부렉시컬 환경에대한 참조로 구성되며,
                전역 렉시컬환경이 생성되는 과정은 다음과 같다.
                > 2.1 전역 환경 레코드 생성
                      전역 환경 레코드는 전역변수를 관리하는 전역스코프,
                      전역객체의  빌트인 전역 프로퍼티와 빌트인 전역함수,
                      표준빌트인 객체를 제공한다.
                      let,const 키워드 전역변수는 전역객체의 프로퍼티가 되지않고,
                      개념적인 블록 내에 존재하게 된다.
                      var 전역변수와 let,const 전역변수를 구분하기 위해 전역환경 레코드는
                      객체환경레코드와 선언적환경 레코드로 구성되어있다.
                      객체환경레코드는 var 전역변수와 함수선언문으로 선언된 전역함수,
                      빌트인 전역 프로퍼티와 빌트인 전역함수, 표준빌트인 객체를 관리하고
                      선언적 환경 레코드는 let,const전역변수를 관리한다.
                      > 2.1.1 객체환경 레코드 생성
                              객체환경 레코드는 Binding Object라고 부르는 객체와 연결된다.
                              Binding Object는 전역객체를 뜻한다.
                              var전역변수와 함수선언문으로 선언한 전역함수는
                              객체환경 레코드에 연결된 BindingObject를 통해 전역 객체의
                              프로퍼티와 메서드가 된다.
                      > 2.1.2 선언적환경 레코드 생성
                              let,const 전역변수는 선언적 환경 레코드에 등록되고 관리된다.
                              let,const 전역변수는 개념적인 블록 내에 존재하는데
                              개념적인 블록이 바로 전역환경 레코드의 선언적환경 레코드다.
                > 2.2 this 바인딩
                      전역환경 레코드의 [[GlobalThisValue]] 내부슬롯에 this가 바인딩된다.
                      일반적으로 전역코드에서 this는 전역객체다.
                      참고로 객체환경 레코드와 선언적 환경 레코드에는 this바인딩이 없다.
                      this바인딩은 전역환경 레코드와 함수환경 레코드에만 존재한다.
                > 2.3 외부 렉시컬 환경에 대한 참조 결정
                      외부 렉시컬 환경에 대한 참조는 상위 스코프를 가리킨다.
                      평가중인 소스코드가 전역코드라면
                      외부렉시컬 환경에 대한 참조에 null이 할당된다.
    - 전역 코드가 실행된다. 만약 함수가 호출되면 전역코드의 실행을 일시 중단하고
      함수 내부로 이동하여 다음순서대로 함수 평가를 시작한다.
        > 1.함수 실행 컨텍스트 생성
            생성된 함수 실행 컨텍스트는 함수 렉시컬환경이 완성된 다음 실행 컨텍스트 스택에 푸시된다.
          2.함수 렉시컬 환경 생성
            렉시컬환경은 환경레코드와 외부렉시컬환경에대한 참조로 구성된다.
            > 2.1 함수 환경 레코드 생성
                  함수 환경 레코드는 parameter,arguments객체, 함수내부에서 선언한 지역변수와 중첩함수를 등록하고 관리한다.
              2.2 this 바인딩
                  함수 환경 레코드의 [[ThisValue]] 내부슬롯에 this가 바인딩된다.
              2.3 외부 렉시컬 환경에 대한 참조 결정
                  함수정의가 평가된 시점에 실행중인 실행 컨텍스트의 렉시컬 환경의 참조가 할당된다.
                  전역코드에 정의된 전역함수는 실행중인 실행컨텍스트가 전역 실행컨텍스트다
                  따라서 외부 렉시컬 환경에 대한 참조에는 전역 렉시컬 환경의 참조가 할당된다.
                  자바스크립트엔진은 함수정의를 평가하여 함수객체를 생성할 때
                  현재 실행중인 실행컨텍스트의 렉시컬 환경, 즉 함수의 상위스코프를
                  함수객체의 내부슬롯 [[Environment]]에 저장한다.
    - 함수 코드가 실행된다. 런타임이 시작되어 함수의 소스코드가
      순차적으로 실행되며 parameter에 argument가 할당되고, 변수할당문이 실행된다.

23-7. 실행 컨텍스트와 블록 레벨 스코프
    - let,const 키워드로 선언한 변수는 모든 코드블록을 지역스코프로 인정한다.
      만약 전역스코프에 if문이 선언되었다면 if문의 코드블록이 실행되면서
      if문의 코드블록을 위한 블록 레벨 스코프가 생성된다.
      이를 위해 선언적 환경 레코드를 갖는 렉시컬 환경을 새롭게 생성하여 기존의
      전역 렉시컬 환경을 대신하도록 교체한다.








```
